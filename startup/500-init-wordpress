#!/usr/bin/with-contenv bash

# Exit on error
set -e

WORDPRESS_ROOT="$WEBUSER_HOME"
WORDPRESS_CHECK="$WORDPRESS_ROOT/wp-content"
WORDPRESS_SQLITE_DIR="${WORDPRESS_SQLITE_DIR:-/wpsqlitedata}"

if [ ! -d "$WORDPRESS_CHECK" ]; then
    echo; echo "ðŸ¤– Installing Wordpress from scratch"
    rm -f $WORDPRESS_ROOT/index.*
    wp core download --allow-root \
        --locale="${WORDPRESS_LOCALE:-en_US}" \
        --version="${WORDPRESS_VERSION:-6.0.2}" \
        --force
    chown -R $PUID:$PGID $WORDPRESS_ROOT

    echo; echo "âœ¨ Installing wp-sqlite-db from source"
    wget -q -O "$WORDPRESS_CHECK/db.php" https://raw.githubusercontent.com/aaemnnosttv/wp-sqlite-db/master/src/db.php

    echo; echo "âœ¨ Creating wp-config.php file"
    wp config create --allow-root --dbname=wpsqlite --dbuser=wpsqlite --skip-check --extra-php <<PHP
define('DB_FILE', 'wpsqlite.sqlite');
define('DB_DIR', '$WORDPRESS_SQLITE_DIR/');
PHP

    echo; echo "âœ¨ Allow open_basedir outside of $WORDPRESS_ROOT"
    echo "php_admin_value[open_basedir] = none" >> /etc/php/8.1/fpm/pool.d/www.conf
else
    echo; echo "âœ… Wordpress installation found. Nothing to do."
fi

if [ ! -d "$WORDPRESS_SQLITE_DIR" ]; then
    echo; echo "âœ¨ Create folder $WORDPRESS_SQLITE_DIR"
    mkdir $WORDPRESS_SQLITE_DIR

    echo; echo "âœ¨ Change permissions on $WORDPRESS_SQLITE_DIR"
    chown -R $PUID:$PGID $WORDPRESS_SQLITE_DIR
else
    echo; echo "âœ… SQLite data folder found. Nothing to do."
fi

echo; echo "âœ… Done."